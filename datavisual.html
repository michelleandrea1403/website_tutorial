<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1ì¸ ê°€êµ¬ ë°ì´í„° ì‹œê°í™”</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const SingleHouseholdVisualization = () => {
            const containerRef = useRef(null);
            const sceneRef = useRef(null);
            const cameraRef = useRef(null);
            const rendererRef = useRef(null);
            const [isRotating, setIsRotating] = useState(true);
            const [selectedYear, setSelectedYear] = useState(2024);
            const [isAnimating, setIsAnimating] = useState(false);

            // ì‹œê³„ì—´ ë°ì´í„° (1990-2024)
            const timelineData = [
                { year: 1990, total: 257000, ratio: 9.1 },
                { year: 1995, total: 382000, ratio: 12.7 },
                { year: 2000, total: 502000, ratio: 16.3 },
                { year: 2005, total: 675000, ratio: 20.2 },
                { year: 2010, total: 854606, ratio: 23.9 },
                { year: 2015, total: 1116000, ratio: 29.5 },
                { year: 2020, total: 1390701, ratio: 34.2 },
                { year: 2024, total: 1660813, ratio: 39.3 }
            ];

            // 2024ë…„ ì—°ë ¹ëŒ€ë³„ ë°ì´í„° (ê¸°ì¤€)
            const ageGroupBase = [
                { age: '20ì„¸ë¯¸ë§Œ', count: 11594, color: 0xff6b6b, ratio: 0.007 },
                { age: '20-24ì„¸', count: 128843, color: 0xff8787, ratio: 0.078 },
                { age: '25-29ì„¸', count: 281863, color: 0xffa07a, ratio: 0.170 },
                { age: '30-34ì„¸', count: 252180, color: 0xffb84d, ratio: 0.152 },
                { age: '35-39ì„¸', count: 141374, color: 0xffd93d, ratio: 0.085 },
                { age: '40-44ì„¸', count: 109595, color: 0xf4e04d, ratio: 0.066 },
                { age: '45-49ì„¸', count: 86296, color: 0xa8e6cf, ratio: 0.052 },
                { age: '50-54ì„¸', count: 96342, color: 0x7bcfa6, ratio: 0.058 },
                { age: '55-59ì„¸', count: 91215, color: 0x4ecdc4, ratio: 0.055 },
                { age: '60-64ì„¸', count: 105325, color: 0x3da9fc, ratio: 0.063 },
                { age: '65-69ì„¸', count: 110955, color: 0x6a89cc, ratio: 0.067 },
                { age: '70-74ì„¸', count: 81462, color: 0x8e7cc3, ratio: 0.049 },
                { age: '75-79ì„¸', count: 69728, color: 0xb392ac, ratio: 0.042 },
                { age: '80-84ì„¸', count: 53509, color: 0xd896ad, ratio: 0.032 },
                { age: '85ì„¸ì´ìƒ', count: 40532, color: 0xf7a4a4, ratio: 0.024 }
            ];

            // ì—°ë ¹ëŒ€ë³„ ì£¼ìš” ì´ìœ  ë§¤í•‘
            const ageReasonMapping = {
                '20ì„¸ë¯¸ë§Œ': 'ë³¸ì¸ì˜ í•™ì—…Â·ì§ì¥',
                '20-24ì„¸': 'ë³¸ì¸ì˜ í•™ì—…Â·ì§ì¥',
                '25-29ì„¸': 'ë³¸ì¸ì˜ í•™ì—…Â·ì§ì¥',
                '30-34ì„¸': 'ë³¸ì¸ì˜ í•™ì—…Â·ì§ì¥',
                '35-39ì„¸': 'ë³¸ì¸ì˜ í•™ì—…Â·ì§ì¥',
                '40-44ì„¸': 'ë³¸ì¸ì˜ í•™ì—…Â·ì§ì¥',
                '45-49ì„¸': 'í˜¼ì ì‚´ê³  ì‹¶ì–´ì„œ',
                '50-54ì„¸': 'ë³¸ì¸ì˜ ì´í˜¼',
                '55-59ì„¸': 'ë³¸ì¸ì˜ ì´í˜¼',
                '60-64ì„¸': 'ë°°ìš°ìì˜ ì‚¬ë§',
                '65-69ì„¸': 'ë°°ìš°ìì˜ ì‚¬ë§',
                '70-74ì„¸': 'ë°°ìš°ìì˜ ì‚¬ë§',
                '75-79ì„¸': 'ë°°ìš°ìì˜ ì‚¬ë§',
                '80-84ì„¸': 'ë°°ìš°ìì˜ ì‚¬ë§',
                '85ì„¸ì´ìƒ': 'ë°°ìš°ìì˜ ì‚¬ë§'
            };

            // ì¤‘ì‹¬ ì´ìœ  ì¹´í…Œê³ ë¦¬
            const reasonCategories = [
                { name: 'ë°°ìš°ìì˜ ì‚¬ë§', percent: 31.9, color: 0xff6b6b },
                { name: 'ë³¸ì¸ì˜ í•™ì—…Â·ì§ì¥', percent: 22.4, color: 0x4ecdc4 },
                { name: 'í˜¼ì ì‚´ê³  ì‹¶ì–´ì„œ', percent: 14.3, color: 0xffe66d },
                { name: 'ë³¸ì¸ì˜ ì´í˜¼', percent: 13.7, color: 0xffa07a },
                { name: 'ê°€ì¡±ê³¼ ì§€ë‚´ëŠ” ê²ƒì´ ë¶ˆí¸í•´ì„œ', percent: 5.1, color: 0xa8e6cf }
            ];

            // ì„ íƒëœ ì—°ë„ì˜ ë°ì´í„° ê³„ì‚°
            const getCurrentYearData = () => {
                const yearData = timelineData.find(d => d.year === selectedYear);
                if (!yearData) return ageGroupBase;
                
                // ë¹„ìœ¨ì„ ìœ ì§€í•˜ë©´ì„œ ì´í•©ë§Œ ì¡°ì •
                return ageGroupBase.map(age => ({
                    ...age,
                    count: Math.floor(yearData.total * age.ratio)
                }));
            };

            useEffect(() => {
                if (!containerRef.current) return;

                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0x000000);
                sceneRef.current = scene;

                const camera = new THREE.PerspectiveCamera(
                    75,
                    containerRef.current.clientWidth / containerRef.current.clientHeight,
                    0.1,
                    1000
                );
                camera.position.z = 40;
                camera.position.y = 8;
                cameraRef.current = camera;

                const renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(containerRef.current.clientWidth, containerRef.current.clientHeight);
                containerRef.current.appendChild(renderer.domElement);
                rendererRef.current = renderer;

                // ì¤‘ì‹¬ ë…¸ë“œ ê·¸ë£¹
                const centerGroup = new THREE.Group();
                const reasonNodes = [];
                
                reasonCategories.forEach((reason, i) => {
                    const angle = (i / reasonCategories.length) * Math.PI * 2;
                    const radius = 6;
                    const x = Math.cos(angle) * radius;
                    const z = Math.sin(angle) * radius;
                    
                    const geometry = new THREE.SphereGeometry(0.8, 24, 24);
                    const material = new THREE.MeshBasicMaterial({ 
                        color: reason.color,
                        transparent: true,
                        opacity: 0.9
                    });
                    const sphere = new THREE.Mesh(geometry, material);
                    sphere.position.set(x, 0, z);
                    centerGroup.add(sphere);
                    reasonNodes.push({ mesh: sphere, data: reason });

                    const lineGeo = new THREE.BufferGeometry().setFromPoints([
                        new THREE.Vector3(0, 0, 0),
                        new THREE.Vector3(x, 0, z)
                    ]);
                    const lineMat = new THREE.LineBasicMaterial({ 
                        color: reason.color,
                        transparent: true,
                        opacity: 0.8
                    });
                    const line = new THREE.Line(lineGeo, lineMat);
                    centerGroup.add(line);
                });
                scene.add(centerGroup);

                // íŒŒí‹°í´ ìƒì„± í•¨ìˆ˜
                let allParticles = [];
                let allLines = [];
                
                const createParticles = (ageData) => {
                    // ê¸°ì¡´ íŒŒí‹°í´ ì œê±°
                    allParticles.forEach(p => scene.remove(p));
                    allLines.forEach(l => scene.remove(l));
                    allParticles = [];
                    allLines = [];

                    ageData.forEach((ageInfo, ageIndex) => {
                        const particleCount = Math.max(3, Math.floor(ageInfo.count / 10000));
                        
                        for (let i = 0; i < particleCount; i++) {
                            const baseAngle = (ageIndex / ageData.length) * Math.PI * 2;
                            const angleSpread = (Math.PI * 2) / ageData.length * 0.8;
                            const angle = baseAngle + (Math.random() - 0.5) * angleSpread;
                            
                            const radiusMin = 15;
                            const radiusMax = 25;
                            const radius = radiusMin + Math.random() * (radiusMax - radiusMin);
                            
                            const x = Math.cos(angle) * radius;
                            const z = Math.sin(angle) * radius;
                            const y = (Math.random() - 0.5) * 15;

                            const size = 0.15 + Math.random() * 0.15;
                            const geometry = new THREE.SphereGeometry(size, 8, 8);
                            const material = new THREE.MeshBasicMaterial({ 
                                color: ageInfo.color,
                                transparent: true,
                                opacity: 0.7 + Math.random() * 0.2
                            });
                            const particle = new THREE.Mesh(geometry, material);
                            particle.position.set(x, y, z);
                            particle.userData = { 
                                age: ageInfo.age,
                                basePosition: new THREE.Vector3(x, y, z),
                                phase: Math.random() * Math.PI * 2
                            };
                            scene.add(particle);
                            allParticles.push(particle);

                            // ì´ìœ  ë…¸ë“œì™€ ì—°ê²°
                            const mainReason = ageReasonMapping[ageInfo.age];
                            const reasonNode = reasonNodes.find(r => r.data.name === mainReason);
                            
                            if (reasonNode && Math.random() > 0.7) {
                                const lineGeo = new THREE.BufferGeometry().setFromPoints([
                                    reasonNode.mesh.position,
                                    new THREE.Vector3(x, y, z)
                                ]);
                                const lineMat = new THREE.LineBasicMaterial({ 
                                    color: ageInfo.color,
                                    transparent: true,
                                    opacity: 0.3
                                });
                                const line = new THREE.Line(lineGeo, lineMat);
                                scene.add(line);
                                allLines.push(line);
                            }

                            // ì£¼ë³€ íŒŒí‹°í´ ì—°ê²°
                            if (allParticles.length > 0 && Math.random() > 0.85) {
                                const randomIndex = Math.floor(Math.random() * Math.min(5, allParticles.length));
                                const nearParticle = allParticles[allParticles.length - 1 - randomIndex];
                                
                                const distance = particle.position.distanceTo(nearParticle.position);
                                if (distance < 8) {
                                    const lineGeo = new THREE.BufferGeometry().setFromPoints([
                                        particle.position,
                                        nearParticle.position
                                    ]);
                                    const lineMat = new THREE.LineBasicMaterial({ 
                                        color: 0xffffff,
                                        transparent: true,
                                        opacity: 0.25
                                    });
                                    const line = new THREE.Line(lineGeo, lineMat);
                                    scene.add(line);
                                    allLines.push(line);
                                }
                            }
                        }
                    });
                };

                // ì´ˆê¸° íŒŒí‹°í´ ìƒì„±
                createParticles(getCurrentYearData());

                // ì• ë‹ˆë©”ì´ì…˜
                let time = 0;
                let animationId;
                const animate = () => {
                    animationId = requestAnimationFrame(animate);
                    time += 0.01;

                    if (isRotating) {
                        scene.rotation.y += 0.002;
                        centerGroup.rotation.y += 0.01;
                    }

                    allParticles.forEach((particle, i) => {
                        const userData = particle.userData;
                        const phase = userData.phase;
                        
                        particle.position.x = userData.basePosition.x + Math.sin(time + phase) * 0.3;
                        particle.position.y = userData.basePosition.y + Math.cos(time * 0.7 + phase) * 0.5;
                        particle.position.z = userData.basePosition.z + Math.sin(time * 0.5 + phase) * 0.3;
                        
                        const scale = 1 + Math.sin(time * 2 + phase) * 0.2;
                        particle.scale.set(scale, scale, scale);
                    });

                    centerGroup.children.forEach((child, i) => {
                        if (child instanceof THREE.Mesh) {
                            const scale = 1 + Math.sin(time * 2.5 + i * 0.7) * 0.15;
                            child.scale.set(scale, scale, scale);
                        }
                    });

                    renderer.render(scene, camera);
                };
                animate();

                // ì—°ë„ ë³€ê²½ ì‹œ íŒŒí‹°í´ ì¬ìƒì„±
                const recreateParticles = () => {
                    createParticles(getCurrentYearData());
                };

                const handleMouseMove = (event) => {
                    const mouseX = (event.clientX / window.innerWidth) * 2 - 1;
                    const mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
                    
                    camera.position.x = mouseX * 12;
                    camera.position.y = 8 + mouseY * 10;
                    camera.lookAt(scene.position);
                };

                const handleResize = () => {
                    if (!containerRef.current) return;
                    camera.aspect = containerRef.current.clientWidth / containerRef.current.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(containerRef.current.clientWidth, containerRef.current.clientHeight);
                };

                window.addEventListener('mousemove', handleMouseMove);
                window.addEventListener('resize', handleResize);

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¡œ ì—°ë„ ë³€ê²½ ê°ì§€
                const handleYearChange = () => {
                    recreateParticles();
                };
                window.addEventListener('yearChanged', handleYearChange);

                return () => {
                    cancelAnimationFrame(animationId);
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('resize', handleResize);
                    window.removeEventListener('yearChanged', handleYearChange);
                    if (containerRef.current && renderer.domElement) {
                        containerRef.current.removeChild(renderer.domElement);
                    }
                    renderer.dispose();
                };
            }, [selectedYear, isRotating]);

            const handleYearChange = (year) => {
                setSelectedYear(year);
                window.dispatchEvent(new Event('yearChanged'));
            };

            const playTimeline = () => {
                setIsAnimating(true);
                let currentIndex = 0;
                const interval = setInterval(() => {
                    if (currentIndex >= timelineData.length) {
                        clearInterval(interval);
                        setIsAnimating(false);
                        return;
                    }
                    handleYearChange(timelineData[currentIndex].year);
                    currentIndex++;
                }, 2000);
            };

            const currentYearData = timelineData.find(d => d.year === selectedYear);
            const currentAgeData = getCurrentYearData();
            const totalParticles = currentAgeData.reduce((sum, age) => sum + Math.max(3, Math.floor(age.count / 10000)), 0);

            return (
                <div className="w-full h-screen bg-black relative overflow-hidden">
                    <div ref={containerRef} className="w-full h-full" />
                    
                    {/* íƒ€ì´í‹€ */}
                    <div className="absolute top-6 left-6 text-white">
                        <h1 className="text-4xl font-bold mb-2">1ì¸ ê°€êµ¬ ì¦ê°€ ì¶”ì´ (1990-2024)</h1>
                        <p className="text-lg opacity-80">ì„œìš¸ì‹œ ì‹œê³„ì—´ ë¶„ì„</p>
                    </div>

                    {/* íƒ€ì„ë¼ì¸ ì»¨íŠ¸ë¡¤ */}
                    <div className="absolute top-6 right-6 bg-white bg-opacity-10 backdrop-blur-sm p-5 rounded-lg text-white max-w-md">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-2xl font-bold">{selectedYear}ë…„</h3>
                            <button
                                onClick={playTimeline}
                                disabled={isAnimating}
                                className="bg-white text-black px-4 py-2 rounded text-sm font-medium hover:bg-opacity-90 transition-all disabled:opacity-50"
                            >
                                {isAnimating ? 'ì¬ìƒ ì¤‘...' : 'â–¶ ìë™ ì¬ìƒ'}
                            </button>
                        </div>
                        
                        <div className="mb-4">
                            <div className="text-3xl font-bold mb-1">{currentYearData?.total.toLocaleString()}ëª…</div>
                            <div className="text-sm opacity-70">ì „ì²´ ê°€êµ¬ ëŒ€ë¹„ {currentYearData?.ratio}%</div>
                            <div className="text-xs opacity-60 mt-1">íŒŒí‹°í´: {totalParticles}ê°œ</div>
                        </div>

                        {/* ìŠ¬ë¼ì´ë” */}
                        <div className="space-y-2">
                            <input
                                type="range"
                                min="0"
                                max={timelineData.length - 1}
                                value={timelineData.findIndex(d => d.year === selectedYear)}
                                onChange={(e) => handleYearChange(timelineData[parseInt(e.target.value)].year)}
                                className="w-full h-2 bg-white bg-opacity-20 rounded-lg appearance-none cursor-pointer"
                                style={{
                                    accentColor: '#4ecdc4'
                                }}
                            />
                            <div className="flex justify-between text-xs opacity-70">
                                <span>1990</span>
                                <span>2024</span>
                            </div>
                        </div>

                        {/* ì¦ê°€ìœ¨ */}
                        {selectedYear > 1990 && (
                            <div className="mt-4 p-3 bg-white bg-opacity-10 rounded">
                                <div className="text-xs opacity-70 mb-1">1990ë…„ ëŒ€ë¹„</div>
                                <div className="text-xl font-bold">
                                    +{Math.round((currentYearData.total / 257000 - 1) * 100)}% ì¦ê°€
                                </div>
                            </div>
                        )}
                    </div>

                    {/* ì—°ë„ë³„ ì¶”ì´ ê·¸ë˜í”„ */}
                    <div className="absolute top-64 right-6 bg-white bg-opacity-10 backdrop-blur-sm p-4 rounded-lg text-white max-w-md">
                        <h3 className="text-sm font-bold mb-3 opacity-70">ì—°ë„ë³„ ì¦ê°€ ì¶”ì´</h3>
                        <div className="space-y-2">
                            {timelineData.map((data, i) => (
                                <div 
                                    key={data.year}
                                    className={`flex items-center justify-between text-xs cursor-pointer transition-all ${
                                        data.year === selectedYear ? 'bg-white bg-opacity-20' : 'hover:bg-white hover:bg-opacity-10'
                                    } p-2 rounded`}
                                    onClick={() => handleYearChange(data.year)}
                                >
                                    <span className="font-bold">{data.year}</span>
                                    <div className="flex-1 mx-3">
                                        <div className="w-full bg-white bg-opacity-20 rounded-full h-1.5">
                                            <div 
                                                className="h-1.5 rounded-full bg-gradient-to-r from-blue-400 to-purple-400"
                                                style={{ width: `${(data.total / timelineData[timelineData.length - 1].total) * 100}%` }}
                                            />
                                        </div>
                                    </div>
                                    <span className="font-mono">{(data.total / 10000).toFixed(0)}ë§Œ</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* ì£¼ìš” ì´ìœ  */}
                    <div className="absolute bottom-6 left-6 bg-white bg-opacity-10 backdrop-blur-sm p-5 rounded-lg text-white max-w-md">
                        <h3 className="text-sm opacity-70 mb-3">1ì¸ ê°€êµ¬ ì£¼ìš” ì´ìœ </h3>
                        <div className="space-y-2">
                            {reasonCategories.map((reason, i) => (
                                <div key={i}>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span>{reason.name}</span>
                                        <span className="font-bold">{reason.percent}%</span>
                                    </div>
                                    <div className="w-full bg-white bg-opacity-20 rounded-full h-2">
                                        <div 
                                            className="h-2 rounded-full transition-all"
                                            style={{ 
                                                width: `${reason.percent * 2.5}%`,
                                                backgroundColor: `#${reason.color.toString(16).padStart(6, '0')}`
                                            }}
                                        />
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* ì»¨íŠ¸ë¡¤ */}
                    <div className="absolute bottom-6 right-6 bg-white bg-opacity-10 backdrop-blur-sm p-4 rounded-lg text-white">
                        <button
                            onClick={() => setIsRotating(!isRotating)}
                            className="w-full bg-white text-black px-4 py-2 rounded text-sm font-medium hover:bg-opacity-90 transition-all"
                        >
                            {isRotating ? 'â¸ íšŒì „ ì •ì§€' : 'â–¶ íšŒì „ ì‹œì‘'}
                        </button>
                        <div className="mt-3 text-xs opacity-70 text-center">
                            ë§ˆìš°ìŠ¤ë¡œ ì‹œì  ë³€ê²½
                        </div>
                    </div>

                    {/* ì¸ì‚¬ì´íŠ¸ */}
                    <div className="absolute top-32 left-6 bg-white bg-opacity-10 backdrop-blur-sm p-4 rounded-lg text-white max-w-xs">
                        <h3 className="text-sm font-bold mb-2">ğŸ’¡ ì¸ì‚¬ì´íŠ¸</h3>
                        <div className="text-xs space-y-1 opacity-80">
                            <p>â€¢ <strong>1990â†’2024</strong>: 6.5ë°° ì¦ê°€</p>
                            <p>â€¢ <strong>ìµœê·¼ 5ë…„</strong>: ì—°í‰ê·  7% ì¦ê°€</p>
                            <p>â€¢ <strong>2024ë…„ ê¸°ì¤€</strong>: ì„œìš¸ ê°€êµ¬ì˜ 39.3%</p>
                            <p>â€¢ <strong>íŒŒí‹°í´ = ì¸êµ¬ìˆ˜</strong> (1ë§Œëª…ë‹¹ 1ê°œ)</p>
                        </div>
                    </div>
                </div>
            );
        };

        // Render the component
        ReactDOM.render(<SingleHouseholdVisualization />, document.getElementById('root'));
    </script>
</body>
</html>
